<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=80mm, initial-scale=1.0">
    <title>REPORTE GENERAL DE CUENTAS</title>
    <style>
        /* Estilos generales - Diseño limpio y moderno con interlineado reducido */
        @page {
            margin: 0;
            padding: 0;
            size: 80mm auto;
        }
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            font-size: 2.5mm;
            text-align: center;
            background-color: white;
            color: black;
            line-height: 1.1; /* Ligeramente aumentado para legibilidad */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        #thermal-pos {
            margin: 0 auto;
            max-width: 80mm;
            padding: 1mm;
        }
        .receipt-container {
            border: 1px solid black;
            border-radius: 3px;
            padding: 2mm;
            margin-bottom: 1mm;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1mm;
        }
        .logo {
            width: 22%;
        }
        .logo img {
            max-width: 180%;
            height: auto;
        }
        .store-info {
            width: 78%;
            text-align: right;
        }
        .store-name {
            font-size: 3.5mm;
            font-weight: bold;
            margin-bottom: 0.3mm;
            letter-spacing: 0.1mm;
        }
        .store-details {
            font-size: 2.5mm;
            line-height: 1.1;
            font-weight: bold;
        }
        .store-details br {
            display: none;
        }
        .store-details {
            display: flex;
            flex-direction: column;
        }
        .section-capsule {
            background-color: black;
            color: white;
            padding: 0.7mm 1.5mm;
            border-radius: 1.5mm;
            display: inline-block;
            margin: 1.5mm 0 1mm 0; /* Aumentado margen superior */
            font-weight: bold;
            font-size: 2.5mm;
            text-align: center;
        }
        .info-section {
            padding-top: 0.5mm;
            padding-bottom: 1mm; /* Aumentado padding inferior */
            margin-bottom: 1mm;
            border-bottom: 1px dotted black; /* Cambiado a punteado */
        }
        .info-section:last-child {
             border-bottom: 1px solid black; /* Línea sólida para la última sección */
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8mm;
            text-align: left;
        }
        .info-label {
            font-weight: normal;
            color: black;
        }
        .info-value {
            font-weight: bold;
            text-align: right;
        }
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1mm;
        }
        .table-header th {
            border-bottom: 1px solid black;
            padding: 0.5mm 0;
            font-weight: bold;
            text-align: center;
            font-size: 2.3mm;
        }
        .table-item td {
            padding: 0.8mm 0; /* Aumentado padding vertical */
            border-bottom: 1px solid #000000;
            font-size: 2.5mm;
        }
        .table-item td:last-child {
            text-align: right;
            font-weight: bold;
        }
        .grand-total-section {
            margin-top: 2mm;
            margin-bottom: 1mm;
            padding-top: 1mm;
            border-top: 2px solid black; /* Borde doble */
            border-bottom: 2px solid black;
        }
        .grand-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 4mm; /* Tamaño más grande para el total */
            font-weight: bold;
        }
        .receipt-footer {
            margin-top: 2mm;
            position: relative;
        }
        .footer-content {
            padding: 1mm;
            text-align: center;
            font-size: 2.3mm;
        }
    </style>
</head>
<body onload="window.print()" onfocus="window.close()">

    <div id="thermal-pos">
        <div class="receipt-container">
            <div class="header">
                <div class="logo">
                    <img src="https://lh3.googleusercontent.com/d/1-_IsocnUhx_k6EGsNSpaJUNnQ2Nn4cFj=w2048?name=ISO%20DELGADO.png" alt="Logo Ferretería" />
                </div>
                <div class="store-info">
                    <div class="store-name">FERRESOLUCIONES</div>
                    <div class="store-details">
                        <span>RUC: 1727849695001</span>
                        <span>DIR: LUIS CORDERO Y JOSÉ MEJÍA</span>
                        <span>CEL: 0962248046</span>
                    </div>
                </div>
            </div>

            <div id="print-content"></div>

            <div class="receipt-footer">
                <div class="footer-content">
                    <strong style="font-size: 2.3mm;">FERRESOLUCIONES</strong><br>
                    <strong style="font-size: 2.3mm;">¡GRACIAS POR SU PREFERENCIA!</strong>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para formatear moneda
        function formatCurrency(amount) {
            return parseFloat(amount).toLocaleString('es-EC', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Obtener los parámetros de la URL
        const params = new URLSearchParams(window.location.search);

        // --- Obtener datos del cliente (si existen)
        const nombre_cliente = decodeURIComponent(params.get('nombre_cliente') || '---');
        const cedula_cliente = decodeURIComponent(params.get('cedula_cliente') || '---');
        const direccion_cliente = decodeURIComponent(params.get('direccion_cliente') || '---');
        const telefono_cliente = decodeURIComponent(params.get('telefono_cliente') || '---');

        // --- Obtener el array de cuentas
        const cuentasData = params.has('cuentas') ? JSON.parse(decodeURIComponent(params.get('cuentas'))) : [];
        
        // --- Obtener el total general
        const totalGeneral = params.get('totalGeneral') || '0.00';

        // --- Contenedor principal para el contenido dinámico
        const contentDiv = document.getElementById('print-content');
        let htmlContent = '';

        // 1. Añadir sección de detalles del cliente (una sola vez)
        if (nombre_cliente !== '---') {
            htmlContent += `
                <div style="text-align: left;">
                    <div class="section-capsule">DETALLES DEL CLIENTE</div>
                </div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Cliente</span>
                        <span class="info-value">${nombre_cliente}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Cédula/RUC</span>
                        <span class="info-value">${cedula_cliente}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Dirección</span>
                        <span class="info-value">${direccion_cliente}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Teléfono</span>
                        <span class="info-value">${telefono_cliente}</span>
                    </div>
                </div>
            `;
        }

        // 2. Iterar sobre cada cuenta y generar su HTML
        cuentasData.forEach(cuenta => {
            htmlContent += `
                <div style="text-align: left;">
                    <div class="section-capsule">DETALLES DE LA CUENTA</div>
                </div>
                <div class="info-section">
                    <div class="info-row">
                        <span class="info-label">Nº Recibo</span>
                        <span class="info-value">${cuenta.id || '---'}</span>
                    </div>
                     <div class="info-row">
                        <span class="info-label">Fecha Otorgada</span>
                        <span class="info-value">${cuenta.origen || '---'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tipo</span>
                        <span class="info-value">${cuenta.tipo || '---'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Motivo</span>
                        <span class="info-value">${cuenta.motivo || '---'}</span>
                    </div>
                     <div class="info-row">
                        <span class="info-label">Aprobado por</span>
                        <span class="info-value">${cuenta.aprobadoPor || '---'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Otros Detalles</span>
                        <span class="info-value">${cuenta.otros || '---'}</span>
                    </div>
                </div>

                <div style="text-align: left;">
                    <div class="section-capsule">DETALLES DE LA COMPRA</div>
                </div>
                <table class="products-table">
                    <thead>
                        <tr class="table-header">
                            <th>CANT</th>
                            <th>DESC</th>
                            <th>PRECIO UNIT</th>
                            <th>PRECIO TOTAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-item">
                            <td>1</td>
                            <td>${cuenta.motivo || '---'}</td>
                            <td style="text-align: right;">$ ${formatCurrency(cuenta.monto)}</td>
                            <td style="text-align: right;">$ ${formatCurrency(cuenta.monto)}</td>
                        </tr>
                    </tbody>
                </table>
            `;
        });

        // 3. Añadir la sección de Total General
        htmlContent += `
            <div class="grand-total-section">
                <div class="grand-total-row">
                    <span>TOTAL GENERAL</span>
                    <span>$ ${formatCurrency(totalGeneral)}</span>
                </div>
            </div>
        `;

        // 4. Insertar todo el HTML generado en el div principal
        contentDiv.innerHTML = htmlContent;

    </script>
</body>
</html>
