<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de ventas</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://i.postimg.cc/kXdCrCc1/LOGO-MANA-SAKILLA-5.png">
    
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        #cameraPermissionOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        #cameraPermissionOverlay h2 {
            margin-top: 0;
        }
        #cameraPermissionOverlay button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Overlay para solicitar permiso de cámara -->
    <div id="cameraPermissionOverlay" style="display: none;">
        <h2>Acceso a la cámara</h2>
        <p>El sistema necesita acceso a tu cámara para escanear códigos de productos.</p>
        <button id="requestCameraButton">Permitir acceso a la cámara</button>
    </div>

    <iframe id="main-iframe" src="" allow="camera"></iframe>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // URL base del iframe gestor
            const baseUrl = "https://script.google.com/macros/s/AKfycbxJEy79-nnmipRkZ-WxneQ90xrgf5XszEM_XiqJ_mMzAo9-HzVAHWyOp7nSwLwYk6Od/exec";
            const iframe = document.getElementById('main-iframe');
            const cameraOverlay = document.getElementById('cameraPermissionOverlay');
            const requestCameraButton = document.getElementById('requestCameraButton');
            
            // Comprobar si ya tenemos permiso de cámara almacenado
            const cameraPermissionGranted = localStorage.getItem('cameraPermissionGranted') === 'true';

            // Función más robusta para detectar si es dispositivo móvil
            function isMobileDevice() {
                // Verificar por User-Agent primero (más confiable)
                const mobileRegex = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i;
                if (mobileRegex.test(navigator.userAgent)) {
                    console.log("Detectado móvil por User-Agent");
                    return true;
                }
                
                // También verificar por dimensiones de pantalla (pantallas pequeñas)
                const smallScreen = window.innerWidth <= 768;
                if (smallScreen) {
                    console.log("Detectado móvil por dimensiones de pantalla");
                    return true;
                }
                
                // Verificar si está en modo de simulación móvil (para depuración)
                if (window.navigator.userAgent.indexOf("Mobile") !== -1 || 
                    window.navigator.userAgent.indexOf("Android") !== -1) {
                    console.log("Detectado móvil por simulación");
                    return true;
                }
                
                return false;
            }
            
            // Determinar URL final basado en el tipo de dispositivo
            const isMobile = isMobileDevice();
            
            // Cargar el iframe con el parámetro mobile si corresponde
            iframe.src = baseUrl + (isMobile ? "?mobile=true" : "");
            
            // Solicitar permiso para la cámara
            requestCameraButton.addEventListener('click', async () => {
                try {
                    // Intentar acceder a la cámara directamente
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    
                    // Si llega aquí, el permiso fue concedido
                    console.log('Permiso de cámara concedido');
                    
                    // Guardar en localStorage que el permiso fue concedido
                    localStorage.setItem('cameraPermissionGranted', 'true');
                    
                    // Detener la transmisión, ya que solo necesitábamos el permiso
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Notificar al iframe que el permiso de la cámara ha sido concedido
                    iframe.contentWindow.postMessage({ action: 'cameraPermissionGranted' }, '*');
                    
                    // Ocultar el overlay
                    cameraOverlay.style.display = 'none';
                    
                } catch (error) {
                    console.error('Error al solicitar permiso de cámara:', error);
                    alert('No se pudo acceder a la cámara. Por favor, intenta nuevamente o verifica la configuración de permisos de tu navegador.');
                }
            });
            
            // Escuchar mensajes del iframe
            window.addEventListener('message', event => {
                // Verificar el origen para seguridad
                const iframeOrigin = new URL(iframe.src).origin;
                
                if (event.origin !== iframeOrigin && event.origin !== '*') {
                    console.log('Mensaje recibido de origen no confiable:', event.origin);
                    return;
                }
                
                if (event.data && event.data.action === 'requestCameraPermission') {
                    // El iframe está solicitando permiso de cámara
                    if (!cameraPermissionGranted) {
                        cameraOverlay.style.display = 'flex';
                    } else {
                        // Si ya tenemos permiso, notificar al iframe directamente
                        iframe.contentWindow.postMessage({ action: 'cameraPermissionGranted' }, '*');
                    }
                }
            });
            
            // Redetectar en caso de cambio de tamaño de ventana (útil para tablets y dispositivos que cambian orientación)
            window.addEventListener('resize', function() {
                const currentIsMobile = isMobileDevice();
                if (currentIsMobile !== isMobile) {
                    // Solo actualizar si cambió el estado (de móvil a escritorio o viceversa)
                    iframe.src = baseUrl + (currentIsMobile ? "?mobile=true" : "");
                }
            });
        });
    </script>
</body>
</html>
